
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Gem w/ MCP</title>
</head>
<body style="background-color: #a71e5; font-family: sans-serif; text-align: center; padding-top: 20px; color: black; transition: 0.3s;">
    
    <h1>ğŸ¢ BUSINESS APP (MAIN)</h1>
    
    <div id="data-board" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin: 20px auto; max-width: 400px; display: none;">
        <h3>ğŸ“Š Dá»¯ liá»‡u tá»« MCP System</h3>
        <p>Doanh thu: <strong id="rev" style="font-size: 1.2em; color: #ffd700;">---</strong></p>
        <p>User Online: <strong id="users">---</strong></p>
        <small>Cáº­p nháº­t lÃºc: <span id="sync-time">---</span></small>
    </div>

    <button onclick="callMCP()" style="padding: 15px 30px; font-size: 18px; cursor: pointer; background: #ff4757; color: white; border: none; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        ğŸ”„ SYNC DATA FROM MCP
    </button>
    <p id="status-msg" style="margin-top: 10px; font-style: italic; opacity: 0.8;"></p>

    <script>
        // 1. HÃ m táº£i dá»¯ liá»‡u JSON (Náº¿u file tá»“n táº¡i sau khi deploy)
        async function loadData() {
            try {
                // ThÃªm timestamp Ä‘á»ƒ trÃ¡nh cache trÃ¬nh duyá»‡t
                const res = await fetch('./data.json?t=' + Date.now());
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('data-board').style.display = 'block';
                    document.getElementById('rev').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.total_revenue);
                    document.getElementById('users').innerText = data.active_users;
                    document.getElementById('sync-time').innerText = data.last_sync;
                }
            } catch(e) { console.log("ChÆ°a cÃ³ dá»¯ liá»‡u json"); }
        }

        // 2. HÃ m gá»i MCP Server
        async function callMCP() {
            const btn = document.querySelector('button');
            const status = document.getElementById('status-msg');
            
            btn.disabled = true; 
            btn.innerText = "â³ Äang gá»i MCP...";
            status.innerText = "Äang káº¿t ná»‘i Ä‘áº¿n há»‡ thá»‘ng MCP giáº£ láº­p...";

            try {
                // Gá»i API cá»§a server Node.js giáº£ láº­p
                const res = await fetch('http://localhost:3002/trigger-sync');
                const result = await res.json();
                
                if(result.success) {
                    status.innerText = "âœ… MCP Ä‘Ã£ xá»­ lÃ½ xong! Äang Ä‘áº©y lÃªn GitHub vÃ  chá» Deploy...";
                    btn.innerText = "ğŸš€ Äang Deploy...";
                    
                    // VÃ¬ Coolify cáº§n thá»i gian deploy, ta set timeout reload trang
                    // Thá»±c táº¿ nÃªn dÃ¹ng WebSocket, nhÆ°ng demo reload sau 15s lÃ  á»•n
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 15000); 
                } else {
                    status.innerText = "âŒ Lá»—i: " + result.error;
                    btn.disabled = false; btn.innerText = "ğŸ”„ Thá»­ láº¡i";
                }
            } catch (err) {
                status.innerText = "âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c MCP Server!";
                btn.disabled = false; btn.innerText = "ğŸ”„ Thá»­ láº¡i";
                console.error(err);
            }
        }

        // Tá»± Ä‘á»™ng táº£i dá»¯ liá»‡u khi vÃ o trang
        loadData();
    </script>
</body>
</html>
